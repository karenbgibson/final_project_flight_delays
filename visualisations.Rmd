---
title: "Visualisations"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r}
library(tidyverse)
library(here)
library(lubridate)
library(patchwork)
```

```{r}
all_info <- read_csv("clean_data/all_info_clean.csv")
newark_info <- read_csv("clean_data/newark_info.csv")
```

**Brief**

You have been hired by Newark airport to investigate the effect of weather on aeroplane departure delays.

They believe poor weather conditions are causing too many delays and want to invest in improving facilities, so that aircraft can take off in more types of weather. However, they do not fully understand how serious weather related delays are, and are not sure what type of weather they should be most concerned about. As part of investigating the effect of weather you should investigate other factors to understand how important weather is in comparison to them

They also want to understand how they compare to other New York airports.

*Plan*

Newark only first, then all three airports:
- how busy are each of the airports?
- What factors show a correlation with flight delay or cancellation? Check the following:
  - type of plane
  - carrier
  - destination
  - time of year
  - no of flights in day
- Which of correlated factors are weather related?

*Departure flights distribution across airports*

Data is available from https://www.bts.gov/ on all flights for all airports in the US. 

Looking at 2017 dept data for JFK, LGA and EWR we find the following:

Total schedule dept across all 3 airports: 303, 748
EWR - 115, 968 (38%)
JFK - 94, 454 (31%)
LGA - 93.326 (31%)

The total number of flights matches that of our original dataset. Let's see if our cleaned dataset gives us equally distributed data:

```{r}
all_info %>% 
  group_by(origin) %>% 
  summarise(total_dep_by_origin = n()) %>% 
  mutate(percent_dep = round(
           total_dep_by_origin / 
           sum(total_dep_by_origin) * 100))
```

Our cleaned dataset gives us total schedule dept across all 3 airports: 279,062
EWR - 109,749 (39%)
JFK - 86,889 (31%)
LGA - 82,424 (30%)

The distribution of departures in our cleaned dataset is broadly similar to our original dataset. We can therefore be comfortable that our analysis will provide an accurate representation of the data. 


```{r}
# adding percentage of flights by destination
all_info_percentages <- all_info %>% 
  group_by(origin) %>% 
  mutate(percentage_dep_origin = round(n()/nrow(.)*100)) %>%
  ungroup()
```

```{r}
# adding colour blind accessible palettes for ggplots

cbb_palette_status <- c("#D55E00", "#F0E442", "#009E73")

cbb_palette_airport <- c("#0072B2","#E69F00", "darkgreen")

cbb_palette_grouped <- c("#56B4E9", "#0072B2","#D55E00", "#E69F00", "darkgreen", "#009E73") 

cbb_palette_one = c("#0072B2", "#56B4E9")

cbb_palette_two = c("#D55E00", "#E69F00")

cbb_palette_three = c("darkgreen", "#009E73")
                    
```

```{r}

all_info %>% 
  group_by(origin, status) %>% 
  summarise(total_dep_by_origin = n()) %>% 
  mutate(percent_dep = round(
           total_dep_by_origin / 
           sum(total_dep_by_origin) * 100, 2)) %>% 
  ggplot(aes(x = origin, 
             y = percent_dep,
             fill = status)) +
  geom_col() +
  geom_label(aes(label = percent_dep,
                 group = status),
             position = position_stack(vjust = .5),
             size = 10,
             show.legend = FALSE) +
  scale_fill_manual(values = cbb_palette_status) +
  theme_bw() +
  labs(title = "Flight departure status by airport",
       subtitle = "Year: 2017",
       fill = "status",
       x = "origin airport",
       y = " Ppercent per status") +
  theme(
     text = element_text(size = 20),
     axis.text.x = element_text(size = 20, 
                                angle = 45,
                                hjust = 1),
     axis.text.y = element_text(size = 14))

ggsave("images/airport_departure_status.png",
       height = 7,
       width = 10)
```

```{r}
all_info_ordered <- all_info %>% 
  mutate(month = factor(month, levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>% 
  mutate(weekday = factor(weekday, levels = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")))

```

```{r}
timeseries_ordered <- all_info_ordered %>% 
  group_by(origin, month, status) %>% 
  summarise(total_dep_by_month = n()) %>% 
  mutate(percent_by_status = round(
           total_dep_by_month / 
           sum(total_dep_by_month) * 100, 1))
```
```{r}
# month with most delays by airport
month_most_delays <- timeseries_ordered %>% 
  filter(status == "delayed") %>% 
  group_by(origin) %>% 
  slice_max(percent_by_status)
```

```{r}
# month with fewest delays by airport
timeseries_ordered %>% 
  filter(status == "delayed") %>% 
  group_by(origin) %>% 
  slice_min(percent_by_status)
```


```{r}
# month with most cancellations by airport
timeseries_ordered %>% 
  filter(status == "cancelled") %>% 
  group_by(origin) %>% 
  slice_max(percent_by_status)
```
```{r}
# month with fewest cancellations by airport
timeseries_ordered %>% 
  filter(status == "cancelled") %>% 
  group_by(origin) %>% 
  slice_min(percent_by_status)
```


```{r}
(timeseries_plot_ewr <- timeseries_ordered %>%
   filter(origin == "EWR",
          status != "on time") %>% 
   ggplot(aes(x = month, 
              y = percent_by_status, 
              colour = status,
              group = status,
              label = percent_by_status)) +
   geom_point(size = 1.5, stroke = 1.5) +
   geom_line(size = 1.5) +
   scale_colour_manual(values = cbb_palette_one) +
   theme_bw() +
   labs(title = "Cancelled & delayed flight departures by month",
        subtitle = "Year: 2017",
        x = "",
        y = "%",
        colour = "Status: EWR") +
   scale_y_continuous(limits = c(0, 35), 
                      breaks = seq(0, 35, 10)) +
   theme(plot.title = element_text(
     face = "bold", size = 20),
     plot.subtitle = element_text(
       face = "bold", size = 18),
     text = element_text(size = 16),
     axis.text.x = element_text(size = 14),
     axis.text.y = element_text(size = 14))
)
```
```{r}
(timeseries_plot_jfk <- timeseries_ordered %>%
   filter(origin == "JFK",
          status != "on time") %>% 
   ggplot(aes(x = month, 
              y = percent_by_status, 
              colour = status,
              group = status)) +
   geom_point(size = 1.5, stroke = 1.5) +
   geom_line(size = 1.5) +
   scale_colour_manual(values = cbb_palette_two) +
   theme_bw() + 
   labs(x = "",
        y = "%",
        colour = "Status: JFK") +
   scale_y_continuous(limits = c(0, 35), 
                      breaks = seq(0, 35, 10)) +
      theme(
     text = element_text(size = 16),
     axis.text.x = element_text(size = 14),
     axis.text.y = element_text(size = 14))
)
```

```{r}
(timeseries_plot_lga <- timeseries_ordered %>%
   filter(origin == "LGA",
          status != "on time") %>% 
   ggplot(aes(x = month, 
              y = percent_by_status, 
              colour = status,
              group = status)) +
   geom_point(size = 1.5, stroke = 1.5) +
   geom_line(size = 1.5) +
   scale_colour_manual(values = cbb_palette_three) +
   theme_bw() +
  labs(x = "",
        y = "%",
        colour = "Status: LGA") +
   scale_y_continuous(limits = c(0, 35), 
                      breaks = seq(0, 35, 10)) +
       theme(
     text = element_text(size = 16),
     axis.text.x = element_text(size = 14),
     axis.text.y = element_text(size = 14))
)
```
```{r}
timeseries_plot_ewr / timeseries_plot_jfk / timeseries_plot_lga

ggsave("images/delays_by_month.png",
       width = 10,
       height = 8)
```

```{r}
all_flights_timeseries <- all_info_ordered %>% 
  group_by(origin, month) %>% 
  count(month)
```

```{r}
(all_flights_timeseries_plot <- all_flights_timeseries %>% 
   ggplot(aes(x = month, y = n, 
              group = origin, colour = origin)) +
   geom_point(size = 1.5, stroke = 1.5) +
   geom_line(size = 1.5) +
   scale_colour_manual(values = cbb_palette_airport) +
   theme_bw() +
   labs(title = "Scheduled departures per month",
        subtitle = "Year: 2017",
        x = "",
        y = "Total number of flights") +
   theme(plot.title = element_text(
     face = "bold", size = 20),
     plot.subtitle = element_text(
       face = "bold", size = 18),
     text = element_text(size = 18),
     axis.text.x = element_text(size = 16),
     axis.text.y = element_text(size = 18))
)

ggsave("images/departure_count_by_month.png",
       width = 8,
       height = 7)
```

```{r}
cancelled_timeseries <- all_info_ordered %>% 
  filter(status == "cancelled") %>% 
  group_by(origin, year, month) %>% 
  count(month)
```

```{r}
(cancelled_timeseries_plot <- cancelled_timeseries %>% 
    ggplot(aes(x = month, y = n, 
               group = origin, colour = origin)) +
    geom_point() +
    geom_line()
)
```

```{r}
newark_info %>% 
  filter(status == "delayed") %>% 
  ggplot(aes(x = carrier_name, fill = carrier_name)) +
  geom_bar(position = "dodge",
           show.legend = FALSE) +
    scale_fill_viridis_d() +
  theme_bw() +
  theme(
       text = element_text(size = 18),
     axis.text.x = element_text(size = 14, 
                                angle = 45,
                                hjust = 1),
     axis.text.y = element_text(size = 14)) +
  geom_label(stat = "count",
             aes(label = after_stat(count)),
             position = position_stack(vjust = .5),
             size = 6,
             colour = "white",
             show.legend = FALSE) +
  labs(title = "Delayed flights by carrier - raw count",
       subtitle = "Year: 2017",
       x = "",
       y = "count")

```

```{r}
percent_status_carrier <- newark_info %>%
  group_by(carrier_name, status) %>%
  summarize(count = n()) %>%
  mutate(percentage_per_status = count/sum(count) * 100)
```
```{r}
percent_status_carrier %>% 
  filter(status == "delayed") %>% 
  ggplot(aes(x = carrier_name, 
             y = round(percentage_per_status, 2), 
             fill = carrier_name)) +
  geom_col(show.legend = FALSE) +
  geom_label(aes(label = round(percentage_per_status, 2)),
             position = position_stack(vjust = .5),
             size = 6,
             colour = "white",
             show.legend = FALSE) +
    scale_fill_viridis_d() +
  theme_bw() +
  theme(
       text = element_text(size = 18),
     axis.text.x = element_text(size = 14, 
                                angle = 45,
                                hjust = 1),
     axis.text.y = element_text(size = 14)) +
  labs(title = "Delayed flights by carrier - percentage",
       subtitle = "Year: 2017",
       x = "",
       y = "percent")

```
```{r}
newark_info %>% 
  filter(status != "on time") %>% 
  ggplot(aes(x = carrier_name, fill = status)) +
  geom_bar(show.legend = FALSE) +
  scale_fill_manual(values = cbb_palette_status) +
  theme_bw() +
  theme(
    text = element_text(size = 18),
    axis.text.x = element_text(size = 14, 
                               angle = 45,
                               hjust = 1),
    axis.text.y = element_text(size = 18)) +
  labs(title = "Delayed & cancelled flights by carrier - raw count",
       subtitle = "Year: 2017",
       x = "",
       y = "count")  +
   scale_y_continuous(limits = c(0, 13000), 
                      breaks = seq(0, 13000, 2500))

ggsave("images/ewr_delayed_cancelled_count_by_carrier.png",
       plot = cancel_delayed_carrier_count,
       width = 9, height = 7)
```

```{r}
percent_status_carrier %>% 
  filter(status != "on time") %>% 
  ggplot(aes(x = carrier_name, 
             y = round(percentage_per_status, 2), 
             fill = status)) +
  geom_col() +
  geom_label(aes(label = round(percentage_per_status, 2)),
             position = position_stack(vjust = .5),
             size = 6,
             show.legend = FALSE) +
    scale_fill_manual(values = cbb_palette_status) +
  theme_bw() +
  theme(
       text = element_text(size = 18),
     axis.text.x = element_text(size = 14, 
                                angle = 45,
                                hjust = 1),
     axis.text.y = element_text(size = 18)) +
  labs(title = "Delayed & cancelled flights by carrier - percentage",
       subtitle = "Year: 2017",
       x = "",
       y = "percent per status")

ggsave("images/ewr_delayed_cancelled_by_carrier_percent.png",
       width = 10, height = 7)
```


```{r}
delays_by_time <- newark_info %>%
  group_by(hour, status) %>% 
  summarise(n = n()) %>% 
  mutate(percent = round(n / sum(n) * 100))
```


```{r}
delays_by_time <- newark_info %>%
  group_by(hour, status) %>% 
  summarise(n = n()) %>% 
  mutate(percent = round(n / sum(n) * 100))
```

```{r}
delays_by_time %>% 
  ggplot(aes(x = hour, y = n, fill = status)) +
  geom_col()
```

```{r}
weekday_percentage <- all_info_ordered %>%
  group_by(weekday, status) %>% 
  summarise(n = n()) %>% 
  mutate(percent = round(n/sum(n)*100, 2))
  
```
```{r}
weekday_percentage %>% 
  ggplot(aes(x = weekday, y = percent, fill = status)) +
  geom_col()
```

```{r}
weekday_percentage %>% 
  ggplot(aes(x = weekday, y = percent, fill = status)) +
  geom_col() +
    geom_text(aes(label = str_c(round(percent, 1), "%"), 
                group = status),
                position = position_stack(vjust = .5)) +
  scale_fill_manual(values = cbb_palette_status) +
  theme_bw()
```
# Weather plots

```{r}
visib_round <- newark_info %>% 
  mutate(visib_round = as.factor(round(visib)), .after = visib) %>% 
  group_by(visib_round, status) %>% 
  summarise(n = n()) %>% 
  mutate(percent = round(n/sum(n)*100, 2))
```

```{r}
visib_round %>% 
  ggplot(aes(x = visib_round, y = percent, fill = status)) + 
  geom_col() +
  geom_label(aes(label = str_c(percent), 
                 group = status),
             position = position_stack(vjust = .5),
             size = 6,
             show.legend = FALSE) +
  scale_fill_manual(values = cbb_palette_status) +
  theme_bw() +
      labs(title = "Flight departure status - visibility",
       subtitle = "Year: 2017",
       fill = "status",
       x = "visibility (miles)",
       y = "percent per status") +
       theme(
     text = element_text(size = 18),
     axis.text.x = element_text(size = 18),
     axis.text.y = element_text(size = 18))

ggsave("images/departure_status_visib.png",
       width = 10, height = 7)
```
```{r}
newark_info %>% 
  distinct(wind_speed)
```
```{r}
wind_speed_status <- newark_info %>% 
  group_by(wind_speed, status) %>% 
  summarise(n = n()) %>% 
  mutate(percent = round(n/sum(n)*100, 2))
```
```{r}
wind_speed_status %>% 
  ggplot(aes(x = wind_speed, 
             y = percent, 
             colour = status)) + 
  geom_point() +
  geom_line() +
  scale_colour_manual(values = cbb_palette_status) +
  theme_bw() +
    labs(title = "Flight departure status - wind speed",
       subtitle = "Year: 2017",
       fill = "status",
       x = "wind speed (mph)",
       y = "percent per status") +
       theme(
     text = element_text(size = 18),
     axis.text.x = element_text(size = 14),
     axis.text.y = element_text(size = 14))

ggsave("images/departure_status_wind_speed.png",
       width = 8, height = 7)
```


```{r}
newark_info %>% 
  distinct(snow) %>% 
  arrange(desc(snow))
```

```{r}
snow_status <- newark_info %>% 
  group_by(snow, status) %>% 
  summarise(n = n()) %>% 
  mutate(percent = round(n/sum(n)*100, 2))
```
```{r}
snow_status %>% 
  ggplot(aes(x = as.factor(snow), y = percent, fill = status)) + 
  geom_col() +
  geom_label(aes(label = str_c(round(percent, 1), "%"), 
                 group = status),
             position = position_stack(
               vjust = .5),
             show.legend = FALSE, 
             size = 6) +
  scale_fill_manual(values = cbb_palette_status) +
  theme_bw() +
    labs(title = "Flight departure status - snow depth",
       subtitle = "Year: 2017",
       fill = "status",
       x = "maximum snow depth (mm)",
       y = "percent per status") +
       theme(
     text = element_text(size = 18),
     axis.text.x = element_text(size = 14),
     axis.text.y = element_text(size = 14))

ggsave("images/departure_status_snow.png",
       width = 8, height = 7)
```

```{r}
avg_temp_status <- newark_info %>% 
  mutate(tavg_grouped = case_when(
    tavg_c > 30 ~ "> 30",
    tavg_c > 25 ~ "25.1 - 30",
    tavg_c > 20 ~ "20.1 - 25",
    tavg_c > 15 ~ "15.1 - 20",
    tavg_c > 10 ~ "10.1 - 15",
    tavg_c > 5 ~ "5.1 - 10",
    tavg_c > 0 ~ "0.1 - 5",
    tavg_c > -5 ~ "-5.1 to 0",
    tavg_c <= -5 ~ "< -5",
  )) %>% 
  mutate(tavg_grouped = factor(tavg_grouped, 
                               levels = c("< -5", "-5.1 to 0", "0.1 - 5", "5.1 - 10", "10.1 - 15", "15.1 - 20", "20.1 - 25", "25.1 - 30", "> 30"))) %>% 
  group_by(tavg_grouped, status) %>% 
  summarise(n = n()) %>% 
  mutate(percent = round(n/sum(n)*100, 2))
```
```{r}
avg_temp_status %>% 
  ggplot(aes(x = tavg_grouped, y = percent, 
             fill = status)) + 
  geom_col() +
  geom_label(aes(label = round(percent, 1), 
                group = status),
            position = position_stack(
              vjust = .5),
            size = 6,
            show.legend = FALSE) +
  scale_fill_manual(values = cbb_palette_status) +
  theme_bw() +
    labs(title = "Flight departure status - average temperature",
       subtitle = "Year: 2017",
       fill = "status",
       x = "\ntemperature (°C)",
       y = "percent per status") +
       theme(
     text = element_text(size = 18),
     axis.text.x = element_text(size = 18, 
                                angle = 45,
                                hjust = 1),
     axis.text.y = element_text(size = 18))

ggsave("images/departure_status_temp.png",
       width = 10, height = 7)
```
```{r}
newark_info %>% 
  distinct(prcp)
```


```{r}
precip_status <- newark_info %>% 
  group_by(prcp, status) %>% 
  summarise(n = n()) %>% 
  mutate(percent = round(n/sum(n)*100, 2))
```
```{r}
precip_status %>% 
  ggplot(aes(x = prcp, 
             y = percent, 
             colour = status)) + 
  geom_point() +
  geom_line() +
  scale_colour_manual(values = cbb_palette_status) +
  theme_bw() +
    labs(title = "Flight departure status - precipitation",
       subtitle = "Year: 2017",
       fill = "status",
       x = "precipitation (inches)",
       y = "percent per status") +
       theme(
     text = element_text(size = 18),
     axis.text.x = element_text(size = 14),
     axis.text.y = element_text(size = 14))

ggsave("images/departure_status_precipitation.png",
       width = 8, height = 7)
```

